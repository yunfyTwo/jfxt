<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>巡检过程</title>
    <link rel="stylesheet" href="css/weui.min.css">
    <link rel="stylesheet" href="css/jquery-weui.css">
    <link rel="stylesheet" href="css/demos.css">
    <link rel="stylesheet" href="css/icon.css">
    <script src="js/jquery-2.1.4.js"></script>
    <script src="js/fastclick.js"></script>
    <script src="js/zepto.min.js"></script>
    <script src="js/swipe.js"></script>
    <script src="html5plus://ready"></script>
    <script src="js/common.js"></script>
    <style>
	        .weui-uploader__file_status:before{background: none;}
	        /*图片预览时会用到，将图片放到最上面一层*/
	        .weui-photo-browser-modal{
	            z-index: 999;
	        }
	    </style>
</head>
<body ontouchstart>
<div class="weui_btn_primary weui-header ">
    <div class="weui-header-left"> <a href="index1.html" class="icon icon-109 f-white"></a>  </div>
    <h1 class="weui-header-title">巡检过程</h1>
    <input type="text" value="" style="display: none" id="xjgcId">
</div>
<div class="kong2"></div>
<div class="weui-cells">
    <!-- <div class="weui-cell" style="display: none">
        <div class="weui-cell__hd"><label class="weui-label">单号</label></div>
        <div class="weui-cell__bd">
            <span style="border: 0px;" value="" id="cftzd"></span>
        </div>
    </div> -->
<!-- <div class="weui-cells__title">巡检网元</div>
<div class="weui-cells ">
    <div class="weui-cell weui-cell_select">
        <div class="weui-cell__bd" id="xjjf">
            <input type="text" value="" id="xjjf" style="display: none;"/>
            <select class="weui-select"  onchange="selectedJf(this.value)"  name="jfLists" id="jfXx_list">
            </select>
        </div>
    </div>
</div> -->

<div class="weui-cells__title">巡检网元</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="巡检网元" rows="1" id="xjgcName" readonly="readonly"></textarea>
        </div>
    </div>
</div>
<div class="weui-cells__title">巡检日期</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="巡检日期" rows="1" id="xjsj" readonly="readonly"></textarea>
        </div>
    </div>
</div>

</div>

<div class="weui-cells__title">巡检人员</div>
<div class="weui-cells weui-cells_radio">
    <label class="weui-cell weui-check__label" for="x12">
        <input id="user_id" value="" style="display: none">
        <div class="weui-cell__bd" id="user_name">
        </div>
        <div class="weui-cell__ft">
            <input type="radio" class="weui-check" name="radio2" id="x12" checked="checked">
            <span class="weui-icon-checked"></span>
        </div>
    </label>
</div>

<div class="weui-gallery" id="gallery">
    <span class="weui-gallery__img" id="galleryImg"></span>
</div>
<div class="weui-cells__title">现场照片</div>
<div class="weui-cells sczp">
    <div class="weui-uploader__bd">
        <ul class="weui-uploader__files" id="img2x">
        </ul>
       <!--  <div id="addImg" class="weui-uploader__input-box" style="display: none">
            <form id="uploadImgForm">
                <div id="img">
                    <div class="weui-uploader__input" type="file" id="imgFile" name="imgFile" accept="image/jpg,image/jpeg,image/png,image/gif" multiple></div>
                </div>
            </form>
        </div> -->
    </div>
  <!--   <div id="clearImg" style="display: none">
      <input type="button" value="清空图片" onclick="deleteImg()"/>
    </div> -->
</div>
<div class="weui-cells__title">整改判断</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="是否存在安全隐患" rows="1" id="zgpd" readonly="readonly"></textarea>
        </div>
    </div>
</div>
<div class="weui-cells__title">巡检是否通过</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="巡检是否通过" rows="1" id="xjsftg" readonly="readonly"></textarea>
        </div>
    </div>
</div>

<div class="weui-cells__title">巡检打分</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="巡检打分" rows="1" id="xjdf" readonly="readonly"></textarea>
        </div>
    </div>
</div>


<!-- <div class="weui-cells" id="btnSubmit" style="display: none">
    <a href="#"  class="weui-btn weui-btn_primary" onclick="saveCf()">提交</a>

</div> -->
</body>
<script>
    $(function() {
        FastClick.attach(document.body) ;
    });


</script>
<script src="js/jquery-weui.js"></script>

<script type="text/javascript">
	//初始页面
    $(function(){
        var tmpl = '<li class="weui-uploader__file" style="background-image:url(#url#)"></li>',
            $gallery = $("#gallery"), $galleryImg = $("#galleryImg"),
            $uploaderInput = $("#uploaderInput"),
            $uploaderFiles = $("#uploaderFiles")
        ;

        $uploaderInput.on("change", function(e){
            var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
            for (var i = 0, len = files.length; i < len; ++i) {
                var file = files[i];

                if (url) {
                    src = url.createObjectURL(file);
                } else {
                    src = e.target.result;
                }

                $uploaderFiles.append($(tmpl.replace('#url#', src)));
            }
        });
        $uploaderFiles.on("click", "li", function(){
            $galleryImg.attr("style", this.getAttribute("style"));
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function(){
            $gallery.fadeOut(100);
        });
    });
</script>
<script type="text/javascript">
	   var imgArr = new Array(); //保存多图片路径
    var imgUrls = "";

    var displayValues = $("#years-monthes").val();
    $("#years-monthes").datetimePicker({
        title:"选择日期时间",
        min:'2015-12-10',
        max:'2050-10-01',
        onChange: function (picker, values, displayValues) {
            values = $("#years-monthes").val();
            console.log(values);
        }});
    var id = GetArgsFromHref("id");
    $(function(){
        //获取存储在本地的会员Id
        var storage=window.localStorage;
        var userId = storage.getItem("loginName");
        var permissions = storage.getItem("permissions");
        var dataedit = "merchant:jfCf:edit";
        if(permissions.indexOf(dataedit)>-1){
            $("#btnSubmit").show();
            $("#clearImg").show();
            $("#addImg").show();
        }
        findUser(userId);
        
        xjgcDetail();
    });

    //查询登录用户
    function findUser(userId){
        $.post(
            getContextPath()+"/app/findUser",
            {
                "id": userId
            },
            function (data) {
                if(data.code == 1) {
                    var obj = data.data;
                   // $("#user_name").text(obj.name);
                    $("#user_id").val(obj.id);
                } else {
                    $.toast(data.msg,'forbidden', 8000);
                }
            });
    }
    //查询所有网元
    function findAlljf(){
       var jfId =  $("#xjjf").val();
            $.post(
                getContextPath()+"/app/jfList",
                {

                },
                function (data) {
                    if(data.code == 1) {
                        var arr = data.data;
                        var jfXx_list = '';
                        for (var i = 0; i < arr.length; i++) {
                            var obj = arr[i];
                            var jfID = obj.id;
                            var str="";
                            if(jfID==jfId){
                                str="<option selected value='1' value='"+obj.id+"'>"+obj.name+"</option>";
                            }else{
                                str="<option value='"+obj.id+"'>"+obj.name+"</option>";
                            }
                            jfXx_list+=str;
                        }
                        $("#jfXx_list").html(jfXx_list);
                    } else {
                        $.toast(data.msg,'forbidden', 8000);
                    }
                });
    }
    //惩罚单明细
    function xjgcDetail(){
        $.post(
            getContextPath()+"/app/xjgcDetail",
            {
                "id":id
            },
            function (data) {
                if(data.code == 1) {
                    var  obj = data.data;
                    $("#xjgcId").val(obj.id);//id
                    $("#xjgcName").val(obj.xjjf.name);
                    $("#user_name").text(obj.xjry.name);
                    $("#cftzd").text(obj.cftzd);
                    $("#xjsj").val(obj.xjsj);
                    $("#zgpd").val(obj.zgpd);
                    $("#xjsftg").val(obj.xjsftg);
                    $("#xjdf").val(obj.xjdf);
                    //图片展示，需要判断是否是多张
                    if(obj.xczp!=null){
                    	imgArr=obj.xczp.split("|");
                    	for (var i = 1; i < imgArr.length; i++) {
                    		 var obj = imgArr[i];
                    	$('#img2x').append('<img src="'+ getFilePath() + obj+'" style="width: 100px;height: 80px;margin-left:15px;" onclick="zoomPic('+i+')"/>');
                    	}
                    }
                   
                    findAlljf();
                    var dictCfdx = "cfdx";
                    findDict(dictCfdx);
                    var dictCftd = "cftd";
                    findDict1(dictCftd);
                } else {
                    $.toast(data.msg,'forbidden', 8000);
                }
            });
    };

 
    if(window.plus) {
        plusReady();
    } else {
        document.addEventListener("plusready", plusReady, false);
    }
    // 扩展API准备完成后要执行的操作
    function plusReady() {
        var ws = plus.webview.currentWebview();
        //pw回车可输出plus.webview // ... code
    }

    //点击事件，弹出选择摄像头和相册的选项
    $("#imgFile").click(
        function showActionSheet() {
            var bts = [{
                title: "拍照"
            }, {
                title: "从相册选择"
            }];

            plus.nativeUI.actionSheet({
                    cancel: "取消",
                    buttons: bts
                },
                function(e) {
                    if(e.index == 1) {
                        getImage();
                    } else if(e.index == 2) {
                        galleryImgs();
                    }
                }
            );
        }
    );

    //调用相机拍照
    function getImage() {
        var cmr = plus.camera.getCamera();
        cmr.captureImage(function(p) {
            plus.io.resolveLocalFileSystemURL(p, function(entry) {
                //转为base64并提交到后台
                uploadImg(entry.toLocalURL());
                //compressImage(entry.toLocalURL(),entry.name);
            }, function(e) {
                plus.nativeUI.toast("读取拍照文件错误：" + e.message);
            });
        }, function(e) {}, {
            filter: 'image'
        });
    }
    //从相册选择照片
    function galleryImgs() {
        plus.gallery.pick(function(p) {
            plus.io.resolveLocalFileSystemURL(p, function(entry) {
                //转为base64并提交到后台
                uploadImg(entry.toLocalURL());
                //compressImage(entry.toLocalURL(),entry.name);
            }, function(e) {
                plus.nativeUI.toast("读取拍照文件错误：" + e.message);
            });
        }, function(e) {}, {
            filename: "_doc/camera/",
            filter: "image"
        });

    }

    //图片上传
    function uploadImg(imgPath) {
        var image = new Image();
        image.onload = function() {
            var imgData = getBase64Image(image);
            var formData = new FormData($("#uploadImgForm")[0]);
            $.post(
                getContextPath() + "/app/uploadImg", {
                    "imgData": imgData,
                },
                function(data) {
                    if(data.code == 1) {
                        var obj = data.data;
                        imgArr.push(obj);
                        var index = imgArr.length-1;
                        $('#img2x').append('<img src="'+ getFilePath() + obj +'" style="width: 100px;height: 80px;margin-left:15px;" onclick="zoomPic('+index+')"/>'+'<input type="button" value="删除" onclick="deleteImg()"/>');
                        //$('#img2x').append('<li class="weui-uploader__input-box" style="background-image:url(' + getFilePath() + obj + ')">');
                    } else {
                        alert(data.msg);
                    }

                });
        }
        image.src = imgPath;
        image.style.width = "60px";
        image.style.height = "60px";
    }

    //将图片压缩转成base64
    function getBase64Image(img) {

        var canvas = document.createElement("canvas");
        var width = img.width;
        var height = img.height;

        if(width > height) {
            if(width > 100) {
                height = Math.round(height *= 800 / width);
                width = 400;
            }
        } else {
            if(height > 100) {
                width = Math.round(width *= 800 / height);
                height = 400;
            }
        }
        canvas.width = width; /*设置新的图片的宽度*/
        canvas.height = height; /*设置新的图片的长度*/
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height); /*绘图*/
        var dataURL = canvas.toDataURL("image/png", 1);
        return dataURL.replace("data:image/png;base64,", "");
    }

    //删除图片
    function deleteImg() {
        if(imgArr.length > 0) {
            imgUrls = imgArr.join(",");
        } else {
            return;
        }
        $.post(getContextPath() + "/app/deleteImg", {
                imgUrls: imgUrls,
            },
            function(data) {
                //失败
                if(data.code == 0) {
                    $.toast(data.msg, 'forbidden', 2000);
                } else {
                    imgArr = new Array();
                    $('#img2x').html("");
                    $.toast(data.msg);
                }
            });
    }

  
</script>
<script src="js/jquery-weui2.js"></script>
	<script src="js/swiper.js"></script>
	<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<script type="text/javascript">
	    function zoomPic(index) {
	        var imgs = imgArr;
	        var realImgs = new Array();
	        for(var i = 0;i <imgs.length ;i ++){
	            if(imgs[i] != ""){
	            	console.log(getFilePath()+imgs[i])
	            	var url = getFilePath()+imgs[i];
	                realImgs.push(url);
	            }
	        }
	
	        var bsImg = $.photoBrowser({
	            items: realImgs,
	            initIndex:index
	        });
	        bsImg.open(index);
	    }
	</script>
</html>