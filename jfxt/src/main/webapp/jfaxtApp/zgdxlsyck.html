<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<title>线路整改单详情</title>
		<link rel="stylesheet" href="css/weui.min.css">
		<link rel="stylesheet" href="css/jquery-weui.css">
		<link rel="stylesheet" href="css/demos.css">
		<link rel="stylesheet" href="css/icon.css">
	   <script src="js/jquery-2.1.4.js"></script>
	    <script src="js/fastclick.js"></script>
	    <script src="js/zepto.min.js"></script>
	    <script src="js/swipe.js"></script>
	    <script src="html5plus://ready"></script>
	    <script src="js/jquery-weui.js"></script>
	    <script src="js/common.js"></script>
	    <script src="js/back.js"></script>
	    <style>
        .weui-uploader__file_status:before{background: none;}
        /*图片预览时会用到，将图片放到最上面一层*/
        .weui-photo-browser-modal{
            z-index: 999;
        }
    </style>
	</head>

	<body ontouchstart>
		<div class="weui_btn_primary weui-header ">
			<div class="weui-header-left">
				<a href="zgdxlsy.html" onClick="toXunjian()" class="icon icon-109 f-white"></a>
			</div>
			<h1 class="weui-header-title">线路整改单详情</h1>
			<input type="text" value="" style="display: none" id="zgId">
		</div>
		<div class="kong2"></div>
		<div class="weui-cells">
			<div class="weui-cell">
				<div class="weui-cell__hd"><label for="" class="weui-label">日期</label></div>
				<div class="weui-cell__bd">
					<input class="weui-input" id="years-monthes" type="text" value="" placeholder="请填写整改日期" readonly="readonly">
				</div>
			</div>
		</div>
		<div class="weui-cells__title">巡检网元</div>
		<div class="weui-cells ">
		    <div class="weui-cell">
		        <div class="weui-cell__bd">
		            <textarea class="weui-textarea" placeholder="巡检网元" rows="1" id="xjgcName" readonly="readonly"></textarea>
		        </div>
		    </div>
		</div>
		
<div class="weui-cells__title">问题情况</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入问题情况" rows="3" id="zgwt"></textarea>
            <div class="weui-textarea-counter"><span>0</span>/200</div>
        </div>
    </div>
</div>

<div class="weui-cells__title">处理方式</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入处理方式" rows="1" id="zgfs"></textarea>
        </div>
    </div>
</div>

<div class="weui-cells__title">需新建杆路（km）</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入需新建杆路（km）" rows="1" id="xjgl"></textarea>
        </div>
    </div>
</div>

<div class="weui-cells__title">更换吊线（km）</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入更换吊线（km）" rows="1" id="ghdx"></textarea>
        </div>
    </div>
</div>


<div class="weui-cells__title">更换电杆（根）</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入更换电杆（根）" rows="1" id="ghdg"></textarea>
        </div>
    </div>
</div>


<div class="weui-cells__title">扶正（偏杆/倒杆）（根）</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入扶正杆数（根）" rows="1" id="dgfz"></textarea>
        </div>
    </div>
</div>

<div class="weui-cells__title">新建拉线（条）</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入新建拉线（条）" rows="1" id="xjlx"></textarea>
        </div>
    </div>
</div>

<div class="weui-cells__title">更换拉线（条）</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入更换拉线（条）" rows="1" id="ghlx"></textarea>
        </div>
    </div>
</div>

<div class="weui-cells__title">需更换光缆（km）</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入需更换光缆（km）" rows="1" id="ghgl"></textarea>
        </div>
    </div>
</div>

<div class="weui-cells__title">是否整改完成</div>
<div class="weui-cells" id="messages">
    <div class="weui-cell weui-cell_select">
        <div class="weui-cell__bd" >
            <select class="weui-select" name="select1"  id="iszg" onchange="se(this,'messages')">
                <option value="是">是</option>
                <option value="否">否</option>
            </select>
        </div>
    </div>
</div>
<div class="weui-cells__title">预估费用</div>
<div class="weui-cells ">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <textarea class="weui-textarea" placeholder="请输入预估费用" rows="1" id="ygfy"></textarea>
        </div>
    </div>
</div>	
		<div class="weui-gallery" id="gallery">
			<span class="weui-gallery__img" id="galleryImg"></span>
		</div>
		<div class="weui-cells__title">现场照片</div>
		<div class="weui-cells sczp">
			<div class="weui-uploader__bd">
				<ul class="weui-uploader__files" id="img2x">
				</ul>
				<!-- <div class="weui-uploader__input-box">
					<form id="uploadImgForm">
						<div id="img">
							<div class="weui-uploader__input" type="file" id="imgFile" name="imgFile" accept="image/jpg,image/jpeg,image/png,image/gif" multiple></div>
						</div>
					</form>
				</div> -->
			</div>
			<!-- <input type="button" value="清空图片" onclick="deleteImg()" /> -->
		</div>

		<div class="weui-cells__title">巡检人</div>
		<div class="weui-cells ">
		    <div class="weui-cell">
		        <div class="weui-cell__bd">
		            <textarea class="weui-textarea" placeholder="" rows="1" id="userName" readonly="readonly"></textarea>
		        </div>
		    </div>
		</div>
		
	</body>
<script type="text/javascript">
	var dataedit = 'merchant:jfXlZG:edit'; //整改权限
	var dataedit1 = 'merchant:jfCf:edit';//处罚
	var permissions = "";
	function perCenter(){
        //获取存储在本地的用户Id
        var storage=window.localStorage;
        var userId = storage.getItem("loginName");
        permissions = storage.getItem("permissions");
		if(permissions.indexOf(dataedit1)>0){
			$("#btnSubmit1").show();
		}else{
			if(permissions.indexOf(dataedit)>-1){
				$("#btnSubmit").show();
			}
		}
        findUser(userId);
    }

    //查询登录用户
    function findUser(userId){
        $.post(
            getContextPath()+"/app/findUser",
            {
                "id": userId
            },
            function (data) {
                if(data.code == 1) {
                    var obj = data.data;
                    $("#user_name").text(obj.loginName);
                    $("#userName").text(obj.name);
                    $("#user_nameTp").text(obj.name);
                    $("#user_id").val(obj.id);
                } else {
                    $.toast(data.msg,'forbidden', 8000);
                }
            });
    }
</script>
	<script type="text/javascript">
		$(function() {
			var tmpl = '<li class="weui-uploader__file" style="background-image:url(#url#)"></li>',
				$gallery = $("#gallery"),
				$galleryImg = $("#galleryImg"),
				$uploaderInput = $("#uploaderInput"),
				$uploaderFiles = $("#uploaderFiles");

			$uploaderInput.on("change", function(e) {
				var src, url = window.URL || window.webkitURL || window.mozURL,
					files = e.target.files;
				for(var i = 0, len = files.length; i < len; ++i) {
					var file = files[i];

					if(url) {
						src = url.createObjectURL(file);
					} else {
						src = e.target.result;
					}

					$uploaderFiles.append($(tmpl.replace('#url#', src)));
				}
			});
			$uploaderFiles.on("click", "li", function() {
				$galleryImg.attr("style", this.getAttribute("style"));
				$gallery.fadeIn(100);
			});
			$gallery.on("click", function() {
				$gallery.fadeOut(100);
			});
			perCenter();
			xlzgdDetail();
		});

		//获取路径中的整改单的id
		
		function xlzgdDetail(){
			var id = GetArgsFromHref("ggid");
        $.post(
            getContextPath()+"/app/xlzgdDetail",
            {
                "id":id
            },
            function (data) {
                if(data.code == 1) {
                    var  obj = data.data;
                    $("#ggid").val(obj.id);//id
                    $("#zgdh").text(obj.zgdh);//单号
                    $("#years-monthes").val(obj.zgrq);//日期
                    $("#jf_id").val(obj.zgjf.id);//网元
                    
                     //处罚原因
                    $("#zgwt").val(obj.zgwt);//是否存在安全隐患
                    $("#zgfs").val(obj.zgfs);//隐患简要说明
                    $("#xjgl").val(obj.xjgl);//隐患原因
                    $("#ghdx").val(obj.ghdx);//是否有ODF架/柜
                    $("#ghdg").val(obj.ghdg);//是否需要网络设备整治割接
                    $("#dgfz").val(obj.dgfz);//隐患级别
                    $("#xjlx").val(obj.xjlx);//是否需要光缆割接
                    $("#ghlx").val(obj.ghlx);//光缆割接量（条/芯）
                    $("#ghgl").val(obj.ghgl);//整治批次
                    $("#iszg").val(obj.iszg);//光缆割接量（条/芯）
                    $("#ygfy").val(obj.ygfy);//整治批次
                    $("#imgFile").val(obj.cfxczp);//是否整改完成
                    $("#zgyqms").val(obj.zgyqms);//整改花费费用
                    $("#kzzd4").val(obj.kzzd4);//巡检人员
                    $("#xjgcName").val(obj.zgjf.name);
                    
                    //图片展示，需要判断是否是多张
                    if(obj.cfxczp!=null){
                    	imgArr=obj.cfxczp.split("|");
                    	for (var i = 0; i < imgArr.length; i++) {
                    		 var obj = imgArr[i];
                    	$('#img2x').append('<img src="'+ getFilePath() + obj+'" style="width: 100px;height: 80px;margin-left:15px;" onclick="zoomPic('+i+')"/>');
                    	}
                    }
                    }
                
            });
            
		};
		
		//初始化页面
		$(function() {
			FastClick.attach(document.body);
			//根据参数显示整改网元
		findGg(id);
		});
	</script>
	<script>
		//时间日期的值
		var displayValues = $("#years-monthes").val();

		function toXunjian() {
			//重新跳转到巡检页面，并携带之前巡检页面的ggid
			window.location.href = "xunjian.html?ggid=" + id;
		}

		  //查询公告以及对应网元
	    function findGg(id){
	        $.post(
	            getContextPath()+"/app/findJfbygg",
	            {
	                "id": id
	            },
	            function (data) {
	                if(data.code == 1) {
	                    var obj = data.data;
	                    $("#jf_name").val(obj.name);
	                    $("#jf_id").val(obj.id);
	                } else {
	                    $.toast(data.msg,'forbidden', 8000);
	                }
	            });
	    };
		
		//初始化处罚单日期
		$("#years-monthes").datetimePicker({
			title: "选择日期时间",
			min: '2015-12-10',
			max: '2050-10-01',
			onChange: function(picker, values, displayValues) {
				values = $("#years-monthes").val();
				console.log(values);
			}
		});

		var imgArr = new Array(); //保存多图片路径
		var imgUrls = "";

		//保存整改单
		function saveZg(type) {
			var isZg = $("#iszg").val();
			var zgwt = $("#zgwt").val(); // 整改要求描述
			if(isZg=='否' && zgwt==null){
				$("#kzzd3").val("");
				alert("请填写问题情况");
				return;
			}
			
			var sedDate = $("#years-monthes").val();
			if(sedDate==null && sedDate==''){
				alert("请填写整改日期");
				return;
			}
			
			//提交整改单的信息进行保存
			var jfXlZG = {};
			jfXlZG.id = $("#zgId").val(); // 整改单ID
			jfXlZG.zgjf = $("#jf_id").val(); // 整改网元
			
			jfXlZG.zgrq = new Date(sedDate); // 日期
			jfXlZG.zgwt = $("#zgwt").val(); // 整改要求描述
			jfXlZG.zgfs = $("#zgfs").val();
	        jfXlZG.xjgl = $("#xjgl").val();
	        jfXlZG.ghdx = $("#ghdx").val();//隐患原因
	        jfXlZG.ghdg = $("#ghdg").val();//是否有ODF架/柜
	        jfXlZG.dgfz = $("#dgfz").val();//是否需要网络设备整治割接
	        jfXlZG.xjlx = $("#xjlx").val();//隐患级别
	        jfXlZG.ghlx = $("#ghlx").val();//是否需要光缆割接
	        jfXlZG.ghgl = $("#ghgl").val();//光缆割接量（条/芯）
	        jfXlZG.iszg = $("#iszg").val();//整治批次
	        jfXlZG.ygfy = $("#ygfy").val();//光缆割接量（条/芯）
	        jfXlZG.kzzd4 = $("#userName").val();//巡检人员
	        
			var storage = window.localStorage;
			var userId = storage.getItem("loginName");
			jfXlZG.userId = userId; //当前登录用户ID
			
  			if(xjId!=null && type==1){
				jfXlZG.kzzd1=xjId;//将巡检单和整改单绑定
				jfXlZG.kzzd2 = "cfd";//该字段不为空则开具处罚单
			}
			
			if(imgArr.length > 4) {
				imgUrls = imgArr.join("|");
				jfXlZG.cfxczp = imgUrls;
			} else{
	         	alert("图片至少五张");
	       		return;
	         } 
			if(imgUrls != "") {
				jfXlZG.cfxczp = imgUrls;
			}
			$.post(
				getContextPath() + "/app/saveXlZgd",
				jfXlZG,
				function(data) {
					if(data.code == 1) {
						// $.toast(data.msg, 'forbidden', 8000);
						$.toast(data.msg);
						if(type==1){
							var url = "newcfd.html?ggid="+id+"&&xunjianid="+xjId+"&&zgid="+data.data.id;
							window.open(url);
						}else {
							window.location.href = "index1.html";
						}
//						window.location.href = "index1.html";
					} else {
						$.toast(data.msg, 'forbidden', 8000);
					}
				});
		}

		//以下是调用相机以及图片上传等操作
		if(window.plus) {
			plusReady();
		} else {
			document.addEventListener("plusready", plusReady, false);
		}
		// 扩展API准备完成后要执行的操作
		function plusReady() {
			var ws = plus.webview.currentWebview();
			//pw回车可输出plus.webview // ... code
		}

		//点击事件，弹出选择摄像头和相册的选项
		$("#imgFile").click(
			function showActionSheet() {
				var bts = [{
					title: "拍照"
				}, {
					title: "从相册选择"
				}];

				plus.nativeUI.actionSheet({
						cancel: "取消",
						buttons: bts
					},
					function(e) {
						if(e.index == 1) {
							getImage();
						} else if(e.index == 2) {
							galleryImgs();
						}
					}
				);
			}
		);

		//调用相机拍照
		function getImage() {
			var cmr = plus.camera.getCamera();
			cmr.captureImage(function(p) {
				plus.io.resolveLocalFileSystemURL(p, function(entry) {
					//转为base64并提交到后台
					uploadImg(entry.toLocalURL());
					//compressImage(entry.toLocalURL(),entry.name);
				}, function(e) {
					plus.nativeUI.toast("读取拍照文件错误：" + e.message);
				});
			}, function(e) {}, {
				filter: 'image'
			});
		}
		//从相册选择照片
		function galleryImgs() {
			plus.gallery.pick(function(p) {
				plus.io.resolveLocalFileSystemURL(p, function(entry) {
					//转为base64并提交到后台
					uploadImg(entry.toLocalURL());
					//compressImage(entry.toLocalURL(),entry.name);
				}, function(e) {
					plus.nativeUI.toast("读取拍照文件错误：" + e.message);
				});
			}, function(e) {}, {
				filename: "_doc/camera/",
				filter: "image"
			});

		}

		//图片上传
		function uploadImg(imgPath) {
			var image = new Image();
			image.onload = function() {
				var imgData = getBase64Image(image);
				var formData = new FormData($("#uploadImgForm")[0]);
				$.post(
					getContextPath() + "/app/uploadImg", {
						"imgData": imgData,
					},
					function(data) {
						if(data.code == 1) {
							var obj = data.data;
							imgArr.push(obj);
							var index = imgArr.length-1;
							$('#zgimg').append('<img src="' + getFilePath() + obj + '" style="width: 100px;height: 80px;margin-left:15px;" onclick="zoomPic('+index+')"/>');
							//$('#img2x').append('<li class="weui-uploader__input-box" style="background-image:url(' + getFilePath() + obj + ')">');
						} else {
							alert(data.msg);
						}

					});
			}
			image.src = imgPath;
			image.style.width = "60px";
			image.style.height = "60px";
		}

		//将图片压缩转成base64
		function getBase64Image(img) {

			var canvas = document.createElement("canvas");
			var width = img.width;
			var height = img.height;

			if(width > height) {
				if(width > 100) {
					height = Math.round(height *= 800 / width);
					width = 400;
				}
			} else {
				if(height > 100) {
					width = Math.round(width *= 800 / height);
					height = 400;
				}
			}
			canvas.width = width; /*设置新的图片的宽度*/
			canvas.height = height; /*设置新的图片的长度*/
			var ctx = canvas.getContext("2d");
			ctx.drawImage(img, 0, 0, width, height); /*绘图*/
			var dataURL = canvas.toDataURL("image/png", 1);
			return dataURL.replace("data:image/png;base64,", "");
		}

	//删除图片
	    function deleteImg() {
	        if(imgArr.length > 0) {
	            imgUrls = imgArr.join(",");
	        } else {
	            return;
	        }
	        $.post(getContextPath() + "/app/deleteImg", {
	                imgUrls: imgUrls,
	            },
	            function(data) {
	                //失败
	                if(data.code == 0) {
	                    $.toast(data.msg, 'forbidden', 2000);
	                } else {
	                    imgArr = new Array();
	                    $('#zgimg').html("");
	                    $.toast(data.msg);
	                }
	            });
	    }

		//删除图片
		function deleteImg() {
			if(imgArr.length > 0) {
				imgUrls = imgArr.join(",");
			} else {
				return;
			}
			$.post(getContextPath() + "/app/deleteImg", {
					imgUrls: imgUrls,
				},
				function(data) {
					//失败
					if(data.code == 0) {
						$.toast(data.msg, 'forbidden', 2000);
					} else {
						imgArr = new Array();
						$('#zgimg').html("");
						$.toast(data.msg);
					}
				});
		}
	</script>
<script src="js/jquery-weui2.js"></script>
	<script src="js/swiper.js"></script>
	<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<script type="text/javascript">
	    function zoomPic(index) {
	        var imgs = imgArr;
	        var realImgs = new Array();
	        for(var i = 0;i <imgs.length ;i ++){
	            if(imgs[i] != ""){
	            	console.log(getFilePath()+imgs[i])
	            	var url = getFilePath()+imgs[i];
	                realImgs.push(url);
	            }
	        }
	
	        var bsImg = $.photoBrowser({
	            items: realImgs,
	            initIndex:index
	        });
	        bsImg.open(index);
	    }
	</script>

</html>